@page "/pessoas/consulta"
@using BancoTalentos.Domain.Entity
@using BancoTalentos.Domain.Repositories.Contracts.Interfaces
@using BancoTalentos.UI.Components.Pages.Common
@using QuickKit.Blazor.Components.Grid
@using QuickKit.Blazor.Components.Grid.Export
@using QuickKit.Blazor.Services.Notification
@using Radzen
@using SenacPlataform.Shared.Controllers
@using SenacPlataform.Shared.Extensions
@using static BancoTalentos.Domain.Repositories.PESSOAS_REPOSITORY

@inherits Page
@inject IPESSOAS_REPOSITORY PessoasRepository
@inject NotificationService NotifierService
@inject IJSRuntime JSRuntime

<Grid Data=@_pessoas
      ColumnsDeclared=@GetColumns()
      IsLoading=@IsLoading
      IsExportingCsv=@IsExportingCsv
      IsExportingExcel=@IsExportingExcel
      CustomActionButton=@CustomButtons
      OnExportCSV="@(async args => await ExportCsv(GridComponent, EXPORT_FILE_NAME))"
      OnExportExcel="@(async args => await ExportExcel(GridComponent, EXPORT_FILE_NAME))"
      @ref="GridComponent" />

@code {
    private IEnumerable<ButtonComponent<PESSOAS>> CustomButtons = [];
    private IEnumerable<PESSOAS> _pessoas = [];
    private Grid<PESSOAS> GridComponent;
    private const string EXPORT_FILE_NAME = "Pessoas";

    protected override async Task OnInitializedAsync()
    {
        ToogleLoading();
        try
        {
            await InitializeDataAsync();
            ConfigureCustomButtons();
        }
        catch (Exception ex)
        {
            NotificarErroCarregarDados(ex);
        }
        finally
        {
            ToogleLoading();
        }
    }

    private async Task InitializeDataAsync()
    {
        _pessoas = await PessoasRepository.GetAllAsync();
    }

    private void ConfigureCustomButtons()
    {
        CustomButtons = GetCustomButtons();
    }

    private IEnumerable<GridColumn> GetColumns()
    {
        var output = new List<GridColumn>();

        output.Add(new GridColumn("Código", nameof(PESSOAS.ID), new GridColumnOptions<IRadzenComponent>()
            {
                Type = RadzenFormInputType.Numeric,
            }));

        output.Add(new GridColumn("Nome", nameof(PESSOAS.NOME), new GridColumnOptions<IRadzenComponent>()
            {
                Type = RadzenFormInputType.TextBox,
            }));

        output.Add(new GridColumn("Cargo", nameof(PESSOAS.CARGO), new GridColumnOptions<IRadzenComponent>()
            {
                Type = RadzenFormInputType.TextBox,
            }));

        output.Add(new GridColumn("Carga Horária", nameof(PESSOAS.CARGA_HORARIA), new GridColumnOptions<IRadzenComponent>()
            {
                Type = RadzenFormInputType.Numeric,
            }));

        return output;
    }

    private Task NotificarCliqueLinha(PESSOAS data)
    {
        NotifierService.Notify(new()
            {
                Detail = $"Vendo registro Nª{data.ID}.",
                Severity = NotificationSeverity.Success,
                Summary = "Clique",
                CloseOnClick = true
            });
        return Task.CompletedTask;
    }

    private IEnumerable<ButtonComponent<PESSOAS>> GetCustomButtons()
    {
        return new List<ButtonComponent<PESSOAS>>
        {
            new ButtonComponent<PESSOAS>()
            {
                ButtonStyle = ButtonStyle.Info,
                Icon = "visibility",
                OnClick = EventCallback.Factory.Create<PESSOAS>(this, (data) => { /* Função para visualizar pode ser adicionada aqui */ })
            },
            new ButtonComponent<PESSOAS>()
            {
                ButtonStyle = ButtonStyle.Primary,
                Icon = "edit",
                OnClick = EventCallback.Factory.Create<PESSOAS>(this, (data) => { /* Função para editar pode ser adicionada aqui */ })
            },
            new ButtonComponent<PESSOAS>()
            {
                ButtonStyle = ButtonStyle.Danger,
                Icon = "delete",
                OnClick = EventCallback.Factory.Create<PESSOAS>(this, async (data) => await ConfirmarExcluir(data))
            }
        };
    }

    private async Task ConfirmarExcluir(PESSOAS pessoa)
    {
        bool confirmacao = await JSRuntime.InvokeAsync<bool>("confirm", $"Você tem certeza que deseja excluir {pessoa.NOME}?");

        if (confirmacao)
        {
            var resultado = await PessoasRepository.DeleteAsync(pessoa);
            if (resultado == 0)
            {
                NotifierService.Notify(new()
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Erro",
                        Detail = $"Erro ao excluir a pessoa {pessoa.NOME}.",
                        CloseOnClick = true
                    });
            }
            else
            {
                _pessoas = _pessoas.Where(p => p.ID != pessoa.ID);
                NotifierService.Notify(new()
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Sucesso",
                        Detail = $"Excluído com sucesso.",
                        CloseOnClick = true
                    });
            }
        }
    }
}